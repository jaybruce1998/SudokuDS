#include <stdlib.h>  // for rand(), srand()
#include <time.h>    // for time()
#include <string.h>  // for memcpy
//#include <filesystem.h>// ds file reading

#include <nds.h>
#include "dlx.h"

#include <stdio.h> //printf

typedef struct gb
{
	unsigned int a;
	unsigned long long b;
} GridBits;

GridBits PERMS[46656];
u16 candidates[9][9][9], colors[9][9][9];
int puzzle[9][9];
GridBits* myPerms[8];
int temPerms[17972];
int indSize, colDex=-1, showM=1, mode=0;

int S3[6][3] = {
	{0, 1, 2}, {0, 2, 1}, {1, 0, 2},
	{1, 2, 0}, {2, 0, 1}, {2, 1, 0}
};
int ROW_MAP[216][9], COL_MAP[216][9];
int TRIPLES[216][3][3];
void buildPerms()
{
	int idx = 0, b, c, band, i, cb, r, bit;
	for (int a = 0; a < 6; a++)
		for (b = 0; b < 6; b++)
			for (c = 0; c < 6; c++)
			{
				TRIPLES[idx][0][0] = S3[a][0]; TRIPLES[idx][0][1] = S3[a][1]; TRIPLES[idx][0][2] = S3[a][2];
				TRIPLES[idx][1][0] = S3[b][0]; TRIPLES[idx][1][1] = S3[b][1]; TRIPLES[idx][1][2] = S3[b][2];
				TRIPLES[idx][2][0] = S3[c][0]; TRIPLES[idx][2][1] = S3[c][1]; TRIPLES[idx][2][2] = S3[c][2];
				for (band = 0; band < 3; band++)
					for (i = 0; i < 3; i++) {
						int src = 3 * band + i;
						int dst = 3 * band + TRIPLES[idx][band][i];
						ROW_MAP[idx][dst] = (src % 3) * 3 + (src / 3);
						COL_MAP[idx][src] = dst;
					}
				idx++;
			}
	idx = 0;
	for (int rb = 0; rb < 216; rb++)
		for (cb = 0; cb < 216; cb++)
		{
			PERMS[idx].a=0;
			PERMS[idx].b=0;
			for (r = 0; r < 9; r++)
			{
				bit=r*9+COL_MAP[cb][ROW_MAP[rb][r]];
				if(bit<17)
					PERMS[idx].a|=(1<<bit);
				else
					PERMS[idx].b|=(1LL<<(bit - 17));
			}
			idx++;
		}
}

int randomPerm(int i)
{
	int r=ind[(((unsigned int)rand()<<16)|(unsigned int)rand())%indSize], s=0;
	myPerms[i]=&PERMS[r];
	unsigned long long a=myPerms[i]->a, b=myPerms[i]->b, c, d;
	for(int j=0; j<indSize; j++)
	{
		c=PERMS[ind[j]].a;
		d=PERMS[ind[j]].b;
		if(((a&c)|(b&d))==0LL)
			temPerms[s++]=ind[j];
	}
	memcpy(ind, temPerms, s*sizeof(int));
	indSize=s;
	return r;
}

void makeFilled()
{
	int i, n, s, ss, r, c;
	for(i=0; i<46656; i++)
		ind[i]=i;
	indSize=46656;
	for(i=0; i<5; i++)
		randomPerm(i);
	s=ss=indSize;
	memmove(&ind[s], ind, s*sizeof(int));
	while(1)
	{
		i=randomPerm(5);
		if(indSize)
			randomPerm(6);
		if(indSize)
			break;
		if(ss>35)
		{
			for(n=s; ind[n]!=i; n++);
			memmove(&ind[n], &ind[n+1], (s+ss-n)*sizeof(int));
			memmove(ind, &ind[s], --ss*sizeof(int));
			indSize=ss;
		}
		else
		{
			makeFilled();
			return;
		}
	}
	randomPerm(7);
	memset(correct, 0, sizeof(correct));
	for(n=0; n<8; n++)
	{
		i=0;
		for(r=0; r<9; r++)
			for(c=0; c<9; c++)
			{
				if((i<17?myPerms[n]->a>>i:myPerms[n]->b>>(i-17))&1LL)
					correct[r][c]=n+1;
				i++;
			}
	}
	for(r=0; r<9; r++)
		for(c=0; c<9; c++)
			if(correct[r][c]==0)
				correct[r][c]=9;
}

void swapRows(int a, int b)
{
	memcpy(ind, givens[a], 9*sizeof(int));
	memmove(givens[a], givens[b], 9*sizeof(int));
	memcpy(givens[b], ind, 9*sizeof(int));
}

void swapCols(int a, int b)
{
	int t;
	for(int c=0; c<9; c++)
	{
		t=givens[a][c];
		givens[a][c]=givens[b][c];
		givens[b][c]=t;
	}
}

void applyRandomSymmetry()
{
	int i, l=17, a, b, r, c;
	ind[0]=0;
	ind[1]=1;
	ind[2]=1;
	ind[3]=2;
	ind[4]=2;
	for(i=5; i<11; i++)
		ind[i]=3;
	for(i=11; i<17; i++)
		ind[i]=4;
	for(i=rand()%18; i>0; i--)
	{
		a=rand()%l--;
		r=ind[a];
		memcpy(&ind[a], &ind[a+1], (l-a)*sizeof(int));
		a=rand()%3;
		b=(a+1+rand()%2)%3;
		switch(r)
		{
			case 0:
				for(r = 0; r < 9; r++) 
					for (c = r + 1; c < 9; c++)
					{
						a=givens[r][c];
						givens[r][c]=givens[c][r];
						givens[c][r]=a;
					}
				break;
			case 1:
				a*=3;
				b*=3;
				for(r=0; r<3; r++)
					swapRows(a++, b++);
				break;
			case 2:
				a*=3;
				b*=3;
				for(r=0; r<3; r++)
					swapCols(a++, b++);
				break;
			case 3:
				swapRows(a, b);
				break;
			default:
				swapCols(a, b);
		}
	}
	for(i=rand()%9; i>0; i--)
	{
		a=rand()%9;
		b=(a+1+rand()%8)%9+1;
		a++;
		for(r=0; r<9; r++)
			for(c=0; c<9; c++)
				if(givens[r][c]==a)
					givens[r][c]=b;
				else if(givens[r][c]==b)
					givens[r][c]=a;
	}
}

#define WHITE RGB15(31, 31, 31)|BIT(15)
#define BLACK RGB15(0, 0, 0)|BIT(15)
#define RED RGB15(31, 0, 0)|BIT(15)
#define GREEN RGB15(0, 31, 0)|BIT(15)
u16 COLORS[6]={RED, RGB15(31, 20, 0)|BIT(15), RGB15(31, 31, 0)|BIT(15), GREEN, RGB15(0, 0, 31)|BIT(15), RGB15(31, 0, 31)|BIT(15)};
int yMin, xMin;
int canDraw[9][32]={
	{2, 14, 3, 14, 4, 14, 5, 14, 4, 15, 4, 16, 4, 17, 4, 18, 3, 18, 2, 17},
	{8, 14, 9, 14, 10, 14, 11, 14, 8, 15, 9, 15, 8, 16, 9, 16, 10, 16, 11, 16, 10, 17, 11, 17, 8, 18, 9, 18, 10, 18, 11, 18},
	{15, 14, 16, 14, 17, 14, 18, 14, 17, 15, 18, 15, 15, 16, 16, 16, 17, 16, 18, 16, 17, 17, 18, 17, 15, 18, 16, 18, 17, 18, 18, 18},
	{2, 12, 2, 11, 2, 10, 3, 10, 4, 10, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12},
	{8, 8, 9, 8, 10, 8, 11, 8, 10, 9, 11, 9, 8, 10, 9, 10, 10, 10, 11, 10, 8, 11, 9, 11, 8, 12, 9, 12, 10, 12, 11, 12},
	{15, 8, 16, 8, 17, 8, 18, 8, 15, 9, 18, 9, 15, 10, 16, 10, 17, 10, 18, 10, 15, 11, 15, 12, 16, 12, 17, 12, 18, 12},
	{3, 1, 3, 2, 4, 3, 5, 4, 2, 5, 3, 5, 4, 5, 5, 5},
	{8, 1, 9, 1, 10, 1, 11, 1, 8, 2, 11, 2, 8, 3, 9, 3, 10, 3, 11, 3, 8, 4, 11, 4, 8, 5, 9, 5, 10, 5, 11, 5},
	{15, 5, 16, 5, 17, 5, 18, 5, 15, 3, 16, 3, 17, 3, 15, 4, 18, 1, 18, 2, 18, 3, 18, 4}
};
int canLen[9]={20, 32, 32, 20, 32, 30, 16, 32, 24};
int digDraw[15][420]={//blaze it
	{2, 1, 2, 2, 3, 1, 3, 2, 4, 1, 4, 2, 5, 1, 5, 2, 5, 15, 5, 16, 6, 1, 6, 2, 6, 15, 6, 16, 7, 1, 7, 2, 7, 3, 7, 4, 7, 5, 7, 6, 7, 7, 7, 8, 7, 9, 7, 10, 7, 11, 7, 12, 7, 13, 7, 14, 7, 15, 7, 16, 7, 17, 7, 18, 8, 1, 8, 2, 8, 3, 8, 4, 8, 5, 8, 6, 8, 7, 8, 8, 8, 9, 8, 10, 8, 11, 8, 12, 8, 13, 8, 14, 8, 15, 8, 16, 8, 17, 8, 18, 9, 1, 9, 2, 9, 3, 9, 4, 9, 5, 9, 6, 9, 7, 9, 8, 9, 9, 9, 10, 9, 11, 9, 12, 9, 13, 9, 14, 9, 15, 9, 16, 9, 17, 9, 18, 10, 1, 10, 2, 10, 3, 10, 4, 10, 5, 10, 6, 10, 7, 10, 8, 10, 9, 10, 10, 10, 11, 10, 12, 10, 13, 10, 14, 10, 15, 10, 16, 10, 17, 10, 18, 11, 1, 11, 2, 11, 3, 11, 4, 11, 5, 11, 6, 11, 7, 11, 8, 11, 9, 11, 10, 11, 11, 11, 12, 11, 13, 11, 14, 11, 15, 11, 16, 11, 17, 11, 18, 12, 1, 12, 2, 13, 1, 13, 2, 14, 1, 14, 2, 15, 1, 15, 2, 16, 1, 16, 2},
	{1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 1, 15, 1, 16, 2, 1, 2, 2, 2, 3, 2, 4, 2, 5, 2, 15, 2, 16, 3, 1, 3, 2, 3, 3, 3, 4, 3, 5, 3, 15, 3, 16, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 6, 4, 7, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 6, 5, 7, 5, 15, 5, 16, 5, 17, 5, 18, 6, 1, 6, 2, 6, 3, 6, 4, 6, 5, 6, 6, 6, 7, 6, 17, 6, 18, 7, 1, 7, 2, 7, 3, 7, 4, 7, 5, 7, 6, 7, 7, 7, 8, 7, 9, 7, 10, 7, 17, 7, 18, 8, 1, 8, 2, 8, 3, 8, 4, 8, 5, 8, 6, 8, 7, 8, 8, 8, 9, 8, 10, 8, 17, 8, 18, 9, 1, 9, 2, 9, 6, 9, 7, 9, 8, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 6, 10, 7, 10, 8, 10, 9, 10, 10, 10, 17, 10, 18, 11, 1, 11, 2, 11, 6, 11, 7, 11, 8, 11, 9, 11, 10, 11, 17, 11, 18, 12, 1, 12, 2, 12, 6, 12, 7, 12, 8, 12, 9, 12, 10, 12, 11, 12, 12, 12, 13, 12, 17, 12, 18, 13, 1, 13, 2, 13, 6, 13, 7, 13, 8, 13, 9, 13, 10, 13, 11, 13, 12, 13, 13, 13, 17, 13, 18, 14, 1, 14, 2, 14, 9, 14, 10, 14, 11, 14, 12, 14, 13, 14, 17, 14, 18, 15, 1, 15, 2, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 1, 17, 2, 17, 12, 17, 13, 17, 14, 17, 15, 17, 16, 18, 1, 18, 2, 18, 12, 18, 13, 18, 14, 18, 15, 18, 16},
	{1, 4, 1, 5, 2, 4, 2, 5, 3, 4, 3, 5, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 17, 4, 18, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 17, 5, 18, 6, 1, 6, 2, 6, 17, 6, 18, 7, 1, 7, 2, 7, 9, 7, 10, 7, 17, 7, 18, 8, 1, 8, 2, 8, 9, 8, 10, 8, 17, 8, 18, 9, 1, 9, 2, 9, 9, 9, 10, 9, 11, 9, 12, 9, 13, 9, 17, 9, 18, 10, 1, 10, 2, 10, 9, 10, 10, 10, 11, 10, 12, 10, 13, 10, 17, 10, 18, 11, 1, 11, 2, 11, 9, 11, 10, 11, 11, 11, 12, 11, 13, 11, 17, 11, 18, 12, 1, 12, 2, 12, 9, 12, 10, 12, 11, 12, 12, 12, 13, 12, 14, 12, 15, 12, 16, 12, 17, 12, 18, 13, 1, 13, 2, 13, 9, 13, 10, 13, 11, 13, 12, 13, 13, 13, 14, 13, 15, 13, 16, 13, 17, 13, 18, 14, 1, 14, 2, 14, 9, 14, 10, 14, 14, 14, 15, 14, 16, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 4, 17, 5, 17, 6, 17, 7, 17, 17, 17, 18, 18, 4, 18, 5, 18, 6, 18, 7, 18, 17, 18, 18},
	{1, 7, 1, 8, 1, 9, 1, 10, 1, 11, 2, 7, 2, 8, 2, 9, 2, 10, 2, 11, 3, 7, 3, 8, 3, 9, 3, 10, 3, 11, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 6, 7, 6, 8, 6, 12, 6, 13, 7, 7, 7, 8, 7, 12, 7, 13, 7, 14, 7, 15, 7, 16, 8, 7, 8, 8, 8, 12, 8, 13, 8, 14, 8, 15, 8, 16, 9, 7, 9, 8, 9, 14, 9, 15, 9, 16, 9, 17, 9, 18, 10, 7, 10, 8, 10, 14, 10, 15, 10, 16, 10, 17, 10, 18, 11, 7, 11, 8, 11, 14, 11, 15, 11, 16, 11, 17, 11, 18, 12, 1, 12, 2, 12, 3, 12, 4, 12, 5, 12, 6, 12, 7, 12, 8, 12, 9, 12, 10, 12, 11, 12, 12, 12, 13, 12, 14, 12, 15, 12, 16, 12, 17, 12, 18, 13, 1, 13, 2, 13, 3, 13, 4, 13, 5, 13, 6, 13, 7, 13, 8, 13, 9, 13, 10, 13, 11, 13, 12, 13, 13, 13, 14, 13, 15, 13, 16, 13, 17, 13, 18, 14, 1, 14, 2, 14, 3, 14, 4, 14, 5, 14, 6, 14, 7, 14, 8, 14, 9, 14, 10, 14, 11, 14, 12, 14, 13, 14, 14, 14, 15, 14, 16, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 7, 17, 8, 18, 7, 18, 8},
	{1, 4, 1, 5, 1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 1, 17, 1, 18, 2, 4, 2, 5, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 2, 17, 2, 18, 3, 4, 3, 5, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 3, 17, 3, 18, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 1, 6, 2, 6, 12, 6, 13, 6, 17, 6, 18, 7, 1, 7, 2, 7, 12, 7, 13, 7, 17, 7, 18, 8, 1, 8, 2, 8, 12, 8, 13, 8, 17, 8, 18, 9, 1, 9, 2, 9, 12, 9, 13, 9, 17, 9, 18, 10, 1, 10, 2, 10, 12, 10, 13, 10, 17, 10, 18, 11, 1, 11, 2, 11, 12, 11, 13, 11, 17, 11, 18, 12, 1, 12, 2, 12, 12, 12, 13, 12, 17, 12, 18, 13, 1, 13, 2, 13, 12, 13, 13, 13, 17, 13, 18, 14, 1, 14, 2, 14, 12, 14, 13, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 17, 16, 18, 17, 4, 17, 5, 17, 6, 17, 7, 17, 8, 17, 9, 17, 10, 18, 4, 18, 5, 18, 6, 18, 7, 18, 8, 18, 9, 18, 10},
	{1, 3, 1, 4, 1, 5, 1, 6, 1, 7, 1, 8, 1, 9, 1, 10, 1, 11, 1, 12, 1, 13, 2, 3, 2, 4, 2, 5, 2, 6, 2, 7, 2, 8, 2, 9, 2, 10, 2, 11, 2, 12, 2, 13, 3, 3, 3, 4, 3, 5, 3, 6, 3, 7, 3, 8, 3, 9, 3, 10, 3, 11, 3, 12, 3, 13, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 6, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 6, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 6, 1, 6, 2, 6, 9, 6, 10, 6, 14, 6, 15, 7, 1, 7, 2, 7, 9, 7, 10, 7, 14, 7, 15, 7, 16, 7, 17, 7, 18, 8, 1, 8, 2, 8, 9, 8, 10, 8, 14, 8, 15, 8, 16, 8, 17, 8, 18, 9, 1, 9, 2, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 9, 10, 10, 10, 17, 10, 18, 11, 1, 11, 2, 11, 9, 11, 10, 11, 17, 11, 18, 12, 1, 12, 2, 12, 9, 12, 10, 12, 17, 12, 18, 13, 1, 13, 2, 13, 9, 13, 10, 13, 17, 13, 18, 14, 1, 14, 2, 14, 9, 14, 10, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 17, 16, 18, 17, 3, 17, 4, 17, 5, 17, 6, 17, 7, 18, 3, 18, 4, 18, 5, 18, 6, 18, 7},
	{1, 14, 1, 15, 1, 16, 1, 17, 1, 18, 2, 14, 2, 15, 2, 16, 2, 17, 2, 18, 3, 14, 3, 15, 3, 16, 3, 17, 3, 18, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 17, 6, 18, 7, 1, 7, 2, 7, 3, 7, 4, 7, 5, 7, 6, 7, 7, 7, 8, 7, 17, 7, 18, 8, 1, 8, 2, 8, 3, 8, 4, 8, 5, 8, 6, 8, 7, 8, 8, 8, 17, 8, 18, 9, 1, 9, 2, 9, 3, 9, 4, 9, 5, 9, 6, 9, 7, 9, 8, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 3, 10, 4, 10, 5, 10, 6, 10, 7, 10, 8, 10, 9, 10, 10, 10, 17, 10, 18, 11, 9, 11, 10, 11, 17, 11, 18, 12, 9, 12, 10, 12, 11, 12, 12, 12, 13, 12, 17, 12, 18, 13, 9, 13, 10, 13, 11, 13, 12, 13, 13, 13, 17, 13, 18, 14, 12, 14, 13, 14, 17, 14, 18, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 14, 17, 15, 17, 16, 17, 17, 17, 18, 18, 14, 18, 15, 18, 16, 18, 17, 18, 18},
	{1, 4, 1, 5, 1, 6, 1, 7, 1, 8, 1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 2, 4, 2, 5, 2, 6, 2, 7, 2, 8, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 3, 3, 3, 4, 3, 8, 3, 9, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 4, 1, 4, 2, 4, 3, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 1, 6, 2, 6, 9, 6, 10, 6, 11, 6, 12, 6, 13, 6, 17, 6, 18, 7, 1, 7, 2, 7, 9, 7, 10, 7, 11, 7, 12, 7, 13, 7, 17, 7, 18, 8, 1, 8, 2, 8, 9, 8, 10, 8, 11, 8, 12, 8, 13, 8, 17, 8, 18, 9, 1, 9, 2, 9, 6, 9, 7, 9, 8, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 6, 10, 7, 10, 8, 10, 9, 10, 10, 10, 17, 10, 18, 11, 1, 11, 2, 11, 6, 11, 7, 11, 8, 11, 9, 11, 10, 11, 17, 11, 18, 12, 1, 12, 2, 12, 6, 12, 7, 12, 8, 12, 9, 12, 10, 12, 17, 12, 18, 13, 1, 13, 2, 13, 6, 13, 7, 13, 8, 13, 9, 13, 10, 13, 11, 13, 17, 13, 18, 14, 1, 14, 2, 14, 6, 14, 7, 14, 8, 14, 11, 14, 12, 14, 16, 14, 17, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 17, 4, 17, 5, 17, 6, 17, 7, 17, 8, 18, 4, 18, 5, 18, 6, 18, 7, 18, 8},
	{1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 4, 1, 4, 2, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 1, 6, 2, 6, 9, 6, 10, 6, 17, 6, 18, 7, 1, 7, 2, 7, 9, 7, 10, 7, 17, 7, 18, 8, 1, 8, 2, 8, 9, 8, 10, 8, 17, 8, 18, 9, 1, 9, 2, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 9, 10, 10, 10, 17, 10, 18, 11, 1, 11, 2, 11, 9, 11, 10, 11, 17, 11, 18, 12, 1, 12, 2, 12, 3, 12, 4, 12, 5, 12, 9, 12, 10, 12, 17, 12, 18, 13, 1, 13, 2, 13, 3, 13, 4, 13, 5, 13, 9, 13, 10, 13, 17, 13, 18, 14, 4, 14, 5, 14, 9, 14, 10, 14, 17, 14, 18, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 6, 17, 7, 17, 8, 17, 9, 17, 10, 17, 11, 17, 12, 17, 13, 17, 14, 17, 15, 17, 16, 18, 6, 18, 7, 18, 8, 18, 9, 18, 10, 18, 11, 18, 12, 18, 13, 18, 14, 18, 15, 18, 16},
	{1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 14, 6, 15, 6, 16, 6, 17, 6, 18, 7, 1, 7, 2, 7, 7, 7, 8, 7, 14, 7, 15, 7, 16, 7, 17, 7, 18, 8, 1, 8, 2, 8, 7, 8, 8, 8, 14, 8, 15, 8, 16, 8, 17, 8, 18, 9, 1, 9, 2, 9, 7, 9, 8, 9, 14, 9, 15, 9, 16, 9, 17, 9, 18, 10, 1, 10, 2, 10, 7, 10, 8, 10, 14, 10, 15, 10, 16, 10, 17, 10, 18, 11, 1, 11, 2, 11, 7, 11, 8, 11, 14, 11, 15, 11, 16, 11, 17, 11, 18, 12, 1, 12, 2, 12, 7, 12, 8, 12, 9, 12, 10, 12, 11, 12, 14, 12, 15, 12, 16, 12, 17, 12, 18, 13, 1, 13, 2, 13, 7, 13, 8, 13, 9, 13, 10, 13, 11, 13, 14, 13, 15, 13, 16, 13, 17, 13, 18, 14, 9, 14, 10, 14, 11, 14, 14, 14, 15, 14, 16, 14, 17, 14, 18, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 12, 17, 13, 17, 14, 17, 15, 17, 16, 18, 12, 18, 13, 18, 14, 18, 15, 18, 16},
	{1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 1, 6, 1, 7, 1, 8, 1, 9, 1, 10, 1, 11, 1, 12, 1, 13, 2, 1, 2, 2, 2, 3, 2, 4, 2, 5, 2, 6, 2, 7, 2, 8, 2, 9, 2, 10, 2, 11, 2, 12, 2, 13, 3, 1, 3, 2, 3, 3, 3, 4, 3, 5, 3, 6, 3, 7, 3, 8, 3, 9, 3, 10, 3, 11, 3, 12, 3, 13, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 6, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 6, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 6, 7, 6, 8, 6, 14, 6, 15, 7, 7, 7, 8, 7, 14, 7, 15, 7, 16, 7, 17, 7, 18, 8, 7, 8, 8, 8, 14, 8, 15, 8, 16, 8, 17, 8, 18, 9, 7, 9, 8, 9, 17, 9, 18, 10, 7, 10, 8, 10, 17, 10, 18, 11, 7, 11, 8, 11, 17, 11, 18, 12, 7, 12, 8, 12, 14, 12, 15, 12, 16, 12, 17, 12, 18, 13, 7, 13, 8, 13, 14, 13, 15, 13, 16, 13, 17, 13, 18, 14, 7, 14, 8, 14, 14, 14, 15, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 17, 1, 17, 2, 17, 3, 17, 4, 17, 5, 17, 6, 17, 7, 17, 8, 17, 9, 17, 10, 17, 11, 17, 12, 17, 13, 18, 1, 18, 2, 18, 3, 18, 4, 18, 5, 18, 6, 18, 7, 18, 8, 18, 9, 18, 10, 18, 11, 18, 12, 18, 13},
	{1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 1, 6, 1, 7, 1, 8, 1, 9, 1, 10, 1, 11, 1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 1, 17, 1, 18, 2, 1, 2, 2, 2, 3, 2, 4, 2, 5, 2, 6, 2, 7, 2, 8, 2, 9, 2, 10, 2, 11, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 2, 17, 2, 18, 3, 1, 3, 2, 3, 3, 3, 4, 3, 5, 3, 6, 3, 7, 3, 8, 3, 9, 3, 10, 3, 11, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 3, 17, 3, 18, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 6, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 6, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 12, 6, 13, 6, 14, 6, 15, 6, 16, 7, 12, 7, 13, 7, 14, 7, 15, 7, 16, 8, 12, 8, 13, 8, 14, 8, 15, 8, 16, 9, 6, 9, 7, 9, 8, 9, 9, 9, 10, 9, 11, 9, 12, 9, 13, 10, 6, 10, 7, 10, 8, 10, 9, 10, 10, 10, 11, 10, 12, 10, 13, 11, 12, 11, 13, 12, 12, 12, 13, 12, 14, 12, 15, 12, 16, 13, 12, 13, 13, 13, 14, 13, 15, 13, 16, 14, 12, 14, 13, 14, 14, 14, 15, 14, 16, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 1, 17, 2, 17, 3, 17, 4, 17, 5, 17, 6, 17, 7, 17, 8, 17, 9, 17, 10, 17, 11, 17, 12, 17, 13, 17, 14, 17, 15, 17, 16, 17, 17, 17, 18, 18, 1, 18, 2, 18, 3, 18, 4, 18, 5, 18, 6, 18, 7, 18, 8, 18, 9, 18, 10, 18, 11, 18, 12, 18, 13, 18, 14, 18, 15, 18, 16, 18, 17, 18, 18},
	{1, 4, 1, 5, 1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 2, 4, 2, 5, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 3, 4, 3, 5, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 1, 6, 2, 6, 9, 6, 10, 6, 17, 6, 18, 7, 1, 7, 2, 7, 9, 7, 10, 7, 17, 7, 18, 8, 1, 8, 2, 8, 9, 8, 10, 8, 17, 8, 18, 9, 1, 9, 2, 9, 9, 9, 10, 9, 17, 9, 18, 10, 1, 10, 2, 10, 9, 10, 10, 10, 17, 10, 18, 11, 1, 11, 2, 11, 9, 11, 10, 11, 17, 11, 18, 12, 1, 12, 2, 12, 9, 12, 10, 12, 17, 12, 18, 13, 1, 13, 2, 13, 9, 13, 10, 13, 17, 13, 18, 14, 1, 14, 2, 14, 9, 14, 10, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 6, 15, 7, 15, 8, 15, 9, 15, 10, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 6, 16, 7, 16, 8, 16, 9, 16, 10, 16, 15, 16, 16, 16, 17, 16, 18, 17, 4, 17, 5, 17, 6, 17, 7, 17, 15, 17, 16, 18, 4, 18, 5, 18, 6, 18, 7, 18, 15, 18, 16},
	{1, 8, 1, 9, 1, 10, 1, 11, 1, 12, 1, 13, 1, 14, 1, 15, 1, 16, 1, 17, 1, 18, 2, 8, 2, 9, 2, 10, 2, 11, 2, 12, 2, 13, 2, 14, 2, 15, 2, 16, 2, 17, 2, 18, 3, 8, 3, 9, 3, 10, 3, 11, 3, 12, 3, 13, 3, 14, 3, 15, 3, 16, 3, 17, 3, 18, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 4, 17, 4, 18, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 5, 17, 5, 18, 6, 7, 6, 8, 6, 9, 6, 10, 6, 11, 7, 4, 7, 5, 7, 6, 7, 7, 7, 8, 7, 9, 7, 10, 7, 11, 8, 4, 8, 5, 8, 6, 8, 7, 8, 8, 8, 9, 8, 10, 8, 11, 9, 1, 9, 2, 9, 3, 9, 4, 9, 5, 9, 6, 9, 7, 9, 8, 10, 1, 10, 2, 10, 3, 10, 4, 10, 5, 10, 6, 10, 7, 10, 8, 11, 4, 11, 5, 11, 6, 11, 7, 11, 8, 12, 4, 12, 5, 12, 6, 12, 7, 12, 8, 12, 9, 12, 10, 12, 11, 13, 4, 13, 5, 13, 6, 13, 7, 13, 8, 13, 9, 13, 10, 13, 11, 14, 7, 14, 8, 14, 9, 14, 10, 14, 11, 15, 7, 15, 8, 15, 9, 15, 10, 15, 11, 15, 12, 15, 13, 15, 14, 15, 15, 15, 16, 15, 17, 15, 18, 16, 7, 16, 8, 16, 9, 16, 10, 16, 11, 16, 12, 16, 13, 16, 14, 16, 15, 16, 16, 16, 17, 16, 18, 17, 8, 17, 9, 17, 10, 17, 11, 17, 12, 17, 13, 17, 14, 17, 15, 17, 16, 17, 17, 17, 18, 18, 8, 18, 9, 18, 10, 18, 11, 18, 12, 18, 13, 18, 14, 18, 15, 18, 16, 18, 17, 18, 18},
	{1, 6, 1, 7, 1, 8, 1, 9, 1, 10, 1, 11, 1, 12, 1, 13, 2, 6, 2, 7, 2, 8, 2, 9, 2, 10, 2, 11, 2, 12, 2, 13, 3, 6, 3, 7, 3, 8, 3, 9, 3, 10, 3, 11, 3, 12, 3, 13, 4, 4, 4, 5, 4, 6, 4, 7, 4, 8, 4, 9, 4, 10, 4, 11, 4, 12, 4, 13, 4, 14, 4, 15, 4, 16, 5, 4, 5, 5, 5, 6, 5, 7, 5, 8, 5, 9, 5, 10, 5, 11, 5, 12, 5, 13, 5, 14, 5, 15, 5, 16, 6, 4, 6, 5, 6, 15, 6, 16, 7, 1, 7, 2, 7, 3, 7, 4, 7, 5, 7, 15, 7, 16, 7, 17, 7, 18, 8, 1, 8, 2, 8, 3, 8, 4, 8, 5, 8, 15, 8, 16, 8, 17, 8, 18, 9, 1, 9, 2, 9, 17, 9, 18, 10, 1, 10, 2, 10, 17, 10, 18, 11, 1, 11, 2, 11, 17, 11, 18, 12, 1, 12, 2, 12, 17, 12, 18, 13, 1, 13, 2, 13, 17, 13, 18, 14, 1, 14, 2, 14, 17, 14, 18, 15, 1, 15, 2, 15, 3, 15, 4, 15, 5, 15, 15, 15, 16, 15, 17, 15, 18, 16, 1, 16, 2, 16, 3, 16, 4, 16, 5, 16, 15, 16, 16, 16, 17, 16, 18, 17, 4, 17, 5, 17, 15, 17, 16, 18, 4, 18, 5, 18, 15, 18, 16}
};//y1, x1, y2, x2...
int digLen[15]={228, 348, 276, 324, 298, 314, 234, 344, 302, 282, 346, 420, 290, 332, 244};//1-9, ?AMS, VC
int PRESSED[9];//A, B, X, Y, R, SELECT, START, UP, DOWN

int getMin(int n)
{
	return n*21+n/3+1;
}
void setXY(int r, int c)
{
	yMin=getMin(c);
	xMin=64+getMin(8-r);
}
void resetCell(u16* bottom, int r, int c)
{
	int x;
	setXY(r, c);
	c=yMin+20;
	r=xMin+20;
	for(int y=yMin; y<c; y++)
		for(x=xMin; x<r; x++)
			bottom[y*256+x]=WHITE;
}
void drawCan(u16* bottom)
{
	int c, d, y, ym, x, xm, i;
	for(int r=0; r<9; r++)
		for(c=0; c<9; c++)
			if(!puzzle[r][c])
			{
				resetCell(bottom, r, c);
				for(d=0; d<9; d++)
				{
					if(candidates[r][c][d])
					{
						y=yMin+(d%3)*7;
						xm=xMin+(2-d/3)*7+6;
						for(ym=y+6; y<ym; y++)
							for(x=xm-6; x<xm; x++)
								bottom[y*256+x]=colors[r][c][d];
						for(i=0; i<canLen[d]; i+=2)
							bottom[(yMin+canDraw[d][i])*256+xMin+canDraw[d][i+1]]=BLACK;
					}
				}
			}
}
void drawDigit(u16* bottom, int r, int c, int d, u16 color)
{
	resetCell(bottom, r, c);
	for(int i=0; i<digLen[d]; i+=2)
		bottom[(yMin+digDraw[d][i])*256+xMin+digDraw[d][i+1]]=color;
}
void drawDigits(u16* bottom)
{
	int c;
	for(int r=0; r<9; r++)
		for(c=0; c<9; c++)
			if(puzzle[r][c])
				drawDigit(bottom, r, c, puzzle[r][c]-1, givens[r][c]?BLACK:showM&&puzzle[r][c]!=correct[r][c]?RED:GREEN);
			else
				resetCell(bottom, r, c);
}
void drawBox(u16* bottom, int r, int c, u16 color)
{
	setXY(r, c);
	xMin--;
	int t=--yMin*256, ym=yMin+21, ty=ym*256, xm=xMin+21;
	for(int i=0; i<21; i++)
	{
		bottom[(yMin+i)*256+xMin]=color;
		bottom[t+xMin+i]=color;
		bottom[(yMin+i)*256+xm]=color;
		bottom[ty+xMin+i]=color;
	}
	bottom[ty+xm]=color;
}
void propogate(int r, int c)
{
	int d=puzzle[r][c]-1, i, j;
	for(i=0; i<9; i++)
	{
		candidates[i][c][d]=0;
		candidates[r][i][d]=0;
	}
	i=r/3*3;
	c=c/3*3+3;
	for(r=i+3; i<r; i++)
		for(j=c-3; j<c; j++)
			candidates[i][j][d]=0;
}
void changeMode(u16* top, u16* bottom, int m)
{
	drawBox(top, 2, mode, WHITE);
	mode=m;
	drawBox(top, 2, m, RED);
	if(colDex>=0)
	{
		drawBox(bottom, 9, colDex, WHITE);
		colDex=-1;
	}
}
void resetColors()
{
	int c, d;
	for(int r=0; r<9; r++)
		for(c=0; c<9; c++)
			for(d=0; d<9; d++)
				colors[r][c][d]=WHITE;
}
void randomizeColor(u16* top)
{
	int i=rand()|BIT(15), x;
	for(int y=43; y<63; y++)
		for(x=193; x<213; x++)
			top[y*256+x]=i;
}

int main()
{
	touchPosition touchXY;
	
	videoSetMode(MODE_5_2D);
	vramSetBankA(VRAM_A_MAIN_BG);
	videoSetModeSub(MODE_5_2D);
	vramSetBankC(VRAM_C_SUB_BG);
	int bt = bgInit(2, BgType_Bmp16, BgSize_B16_256x256, 0, 0), bb=bgInitSub(2, BgType_Bmp16, BgSize_B16_256x256, 0, 0), keys, y, x, i=0, r, c, selected=1, dif=0, autoCan=1, single=1;
	u16 *top=(u16*)bgGetGfxPtr(bt), *bottom=(u16*)bgGetGfxPtr(bb);
	for(y=0; y<192; y++)
		for(x=0; x<256; x++)
			top[y*256+x]=bottom[y*256+x]=WHITE;
	drawBox(top, 0, 0, RED);
	for(x=0; x<4; x++)
		drawDigit(top, 0, x, x, BLACK);
	drawDigit(top, 0, 4, 9, BLACK);
	for(x=0; x<3; x++)
		drawDigit(top, 1, x, 10+x, GREEN);
	drawBox(top, 2, 0, RED);
	drawDigit(top, 2, 0, 13, BLACK);
	drawDigit(top, 2, 1, 14, BLACK);
	
	for(x=64; x<256; x+=21)
	{
		for(y=0; y<192; y++)
			bottom[y*256+x]=BLACK;
		if(++i==4||i==8)
			x-=20;
	}
	i=0;
	for(y=0; y<192; y+=21)
	{
		for(x=65; x<255; x++)
			bottom[y*256+x]=BLACK;
		if(++i==4||i==8)
			y-=20;
	}
	for(i=0; i<6; i++)
	{
		setXY(9, i);
		for(y=yMin+18; y>=yMin; y--)
			for(x=xMin+18; x>xMin; x--)
				bottom[y*256+x]=COLORS[i];
	}
	drawBox(bottom, 10, 0, RED);
	for(x=0; x<9; x++)
		drawDigit(bottom, 10, x, x, BLACK);
	srand(time(NULL));
	randomizeColor(top);
	buildPerms();
	setupDLX();
	resetColors();
	while(1)
	{
		scanKeys();
		keys=keysDown();
		if(keys&KEY_TOUCH)
		{
			touchRead(&touchXY);
			y=touchXY.py;
			x=touchXY.px;
			c=(y-y/128)/21;
			r=(x-(x-64)/128)/21;
			if(r>11)
				continue;
			r=11-r;
			if(r==9)
			{
				changeMode(top, bottom, 2);
				drawBox(bottom, 9, c, BLACK);
				colDex=c;
				continue;
			}
			if(r==10)
			{
				drawBox(bottom, r, selected-1, WHITE);
				drawBox(bottom, r, c, RED);
				selected=c+1;
				continue;
			}
			if(r==11)//more buttons?
				continue;
			if(!givens[r][c])
				switch(mode)
				{
					case 0:
						resetCell(bottom, r, c);
						if(puzzle[r][c]==selected)
							puzzle[r][c]=0;
						else
						{
							puzzle[r][c]=selected;
							if(autoCan)
							{
								propogate(r, c);
								drawCan(bottom);
							}
							drawDigit(bottom, r, c, selected-1, showM&&selected!=correct[r][c]?RED:GREEN);
						}
						break;
					case 1:
						colors[r][c][selected-1]=WHITE;
						candidates[r][c][selected-1]=!candidates[r][c][selected-1];
						drawCan(bottom);
						break;
					default:
						colors[r][c][selected-1]=colors[r][c][selected-1]==COLORS[colDex]?WHITE:COLORS[colDex];
						if(single)
							for(x=0; x<9; x++)
								if(colors[r][c][x]!=COLORS[colDex])
									colors[r][c][x]=WHITE;
						drawCan(bottom);
				}
		}
		if(keys&KEY_A)//A=auto, B=mistakes, X=candidateReset, Y=colorReset, R=single color, SELECT=mode, START
		{
			if(PRESSED[0])
				continue;
			autoCan=!autoCan;
			drawDigit(top, 1, 0, 10, autoCan?GREEN:RED);
		}
		else
			PRESSED[0]=0;
		if(keys&KEY_B)
		{
			if(PRESSED[1])
				continue;
			showM=!showM;
			drawDigit(top, 1, 1, 11, showM?GREEN:RED);
			drawDigits(bottom);
		}
		else
			PRESSED[1]=0;
		if(keys&KEY_X)
		{
			if(PRESSED[2])
				continue;
			memset(candidates, 1, sizeof(candidates));
			if(autoCan)
				for(r=0; r<9; r++)
					for(c=0; c<9; c++)
						if(puzzle[r][c])
							propogate(r, c);
			drawCan(bottom);
		}
		else
			PRESSED[2]=0;
		if(keys&KEY_Y)
		{
			if(PRESSED[3])
				continue;
			resetColors();
			drawCan(bottom);
		}
		else
			PRESSED[3]=0;
		if(keys&KEY_R)
		{
			if(PRESSED[4])
				continue;
			single=!single;
			drawDigit(top, 1, 2, 12, single?GREEN:RED);
		}
		else
			PRESSED[4]=0;
		if(keys&KEY_SELECT)
		{
			if(PRESSED[5])
				continue;
			changeMode(top, bottom, !mode);
		}
		else
			PRESSED[5]=0;
		if(keys&KEY_START)
		{
			if(PRESSED[6])
				continue;
			makeFilled();
			setGivens(dif);
			memcpy(puzzle, givens, sizeof(givens));
			randomizeColor(top);
			drawDigits(bottom);
		}
		else
			PRESSED[6]=0;
		if(keys&KEY_UP)
		{
			if(PRESSED[7])
				continue;
			drawBox(top, 0, dif, WHITE);
			dif=(dif+4)%5;
			drawBox(top, 0, dif, RED);
		}
		else
			PRESSED[7]=0;
		if(keys&KEY_DOWN)
		{
			if(PRESSED[8])
				continue;
			drawBox(top, 0, dif, WHITE);
			dif=(dif+1)%5;
			drawBox(top, 0, dif, RED);
		}
		else
			PRESSED[8]=0;
		swiWaitForVBlank();
	}
	return 0;
}